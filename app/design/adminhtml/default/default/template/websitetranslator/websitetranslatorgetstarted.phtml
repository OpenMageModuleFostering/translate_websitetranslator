<?php

$model = Mage::getModel('websitetranslator/websitetranslator');

if (isset($_POST['wt-settings-submit']))
{
  $settings = array(
    'website_key',
    'remember_language',
    'guess_language',
    'translate_meta',
    'localize_images',
    'localize_bg_images',
    'localize_media'
  );

  foreach ($settings as $setting)
  {
    $setting_value = $_POST[$setting];
    $item = $model->load($setting, 'setting_name');
    $item->setSettingValue($setting_value)->save();
  }
}

?>
<div class="wrap">
  <div>
    <img width="30px" src="https://www.translate.com/images/translate-logo-mark-blue.svg">
    <h1>Website Translator</h1>
  </div>
  <div id="heading-wrapper">
    <div id="heading-title">Setup</div>
    <div id="need-help"><a href="https://translatecom.zendesk.com/hc/en-us/requests/new">Need help?</a></div>
  </div>
  <form method="post" action="<?php echo $this->getUrl('admin_websitetranslator/adminhtml_websitetranslatorbackend'); ?>">
       <div class="box step-one">
         <h2>1. Subscribe to Translate.com</h2>
         <div class="inner-box get-started-subtext">Translate.com's Website Translator only works with a Starter package or above. Click below to view and subscribe to a package.</div>
          <a href="https://translate.com/pages/pricing_languages" target="_blank"><div class="inner-box link-box">View Packages  <i class="fa fa-external-link"></i></div></a>
         <div class="inner-box" id="already_subscribed">Already subscribed to a Translate.com package? Proceed to the next step!</i></div>
        </div>
        <div class="box step-two">
          <h2>2. Add website</h2>
          <div class="inner-box" class="get-started-subtext">Visit Translate.com to add your website URL (Ex: mywebsite.com). This lets us generate a unique Website Key that enables translations on your site.</div>
          <a href="https://translate.com/portal/add_website_step_one" target="_blank"><div style="width: 130px;" class="inner-box link-box">Add Website  <i class="fa fa-external-link"></i></div></a>
        </div>

 <?php
              $resource = Mage::getSingleton('core/resource');

              $readConnection = $resource->getConnection('core_read');
	      $writeConnection = $resource->getConnection('core_write');

              $query = "SELECT setting_value FROM " . $resource->getTableName('translate_wt_settings') . " WHERE setting_name = 'install'";

              $results = $readConnection->fetchAll($query);

              /* get the results */
              $install = $results[0]['setting_value'];

              if($install != 'true')
              {
                $resource = Mage::getSingleton('core/resource');
                $readConnection = $resource->getConnection('core_read');

                $query = "SELECT firstname FROM " . $resource->getTableName('admin_user') . " LIMIT 1";
                $results = $readConnection->fetchAll($query);
                $first_name = $results[0]['firstname'];

                $query = "SELECT lastname FROM " . $resource->getTableName('admin_user') . " LIMIT 1";
                $results = $readConnection->fetchAll($query);
                $last_name = $results[0]['lastname'];

                $query = "SELECT email FROM " . $resource->getTableName('admin_user') . " LIMIT 1";
                $results = $readConnection->fetchAll($query);
                $email = $results[0]['email'];

                $query = "SELECT value FROM " . $resource->getTableName('core_config_data') . " WHERE path = 'web/unsecure/base_url'";
                $results = $readConnection->fetchAll($query);
                $url = $results[0]['value'];

                $details =  'First Name: ' . $first_name . ' Last Name: ' . $last_name . ' Email: ' . $email;

                $body = array(
                  'user_id' => '123',
                  'platform' => 'magento',
                  'website_url' => $url,
                  'details' => $details
                );

                $url = 'https://brandon.translate.com/api_v2/website_translator_install';

		if(function_exists('curl_version'))
                {
		$handle = curl_init();
                curl_setopt($handle, CURLOPT_URL, $url);
                curl_setopt($handle, CURLOPT_POST, true);
                curl_setopt($handle, CURLOPT_RETURNTRANSFER, 1);
                curl_setopt($handle, CURLOPT_POSTFIELDS, $body);

                $response = curl_exec($handle);
                curl_close($handle);

		$query = "UPDATE ". $resource->getTableName('translate_wt_settings') . " SET setting_value = 'true' WHERE setting_name = 'install'";
        	$results = $writeConnection->query($query);
		}
	}
            ?>

        <div class="box step-three">
          <h2>3. Enter website key</h2>
          <div class="inner-box" class="get-started-subtext">Copy and paste the unique key generated by Translate.com below:</div>
          <?php $setting = $model->load('website_key', 'setting_name');?>
            <input type="text" name="website_key" value="<?php echo $setting->getSettingValue(); ?>"/>
            <div>
              <input type="hidden" name="form_key" value="<?php echo Mage::getSingleton('core/session')->getFormKey(); ?>" />
              <input id="wt-settings-submit" name="wt-settings-submit" type="submit" value="Save" onclick"/"/>
            </div>
        </div>
  </form>
</div>
<script src="https://use.fontawesome.com/32e98c2f79.js"></script>
<style>
h1 {
  padding-left: 40px;
  margin-bottom: 30px;
  line-height: .8em;
  letter-spacing: 0.8px;
  font-weight: 400;
}
h2 {
  font-weight: 520;
}
h3 {
  font-weight: 400;
}
img {
  float: left;
}
#heading-wrapper {
  width: 660px;
  overflow: auto;
  margin-bottom: 20px;
}
#heading-title {
  float: left;
  font-size: 16px;
  text-transform: uppercase;
  letter-spacing: 0.8px;
  color: gray;
}
#need-help {
   float: right;
}
#need-help a {
  font-size: 16px;
  text-decoration: none;
  color: #217bb9;
}
.middle {
  background: #ebeef0;
  font-family: '-apple-system', 'BlinkMacSystemFont', 'San Francisco', 'Roboto', 'Segoe UI', 'Helvetica Neue', sans-serif
}
#wt-settings-submit {
  margin-top: 10px;
  width: 150px;
  height: 30px;
  color: white;
  background: #217bb9;
  border-radius: 3px;
  border: none;
  font-size: 13px;
}
i.example {
  color: #999;
}
.box {
  background-color: white;
  margin-bottom: 30px;
  width: 600px;
  padding: 35px 35px 10px 35px;
  box-shadow: 1px 3px 10px rgba(0,0,0,0.1);
  overflow: auto;
  border-radius: 3px;
  letter-spacing: 0.2px;
}
.inner-box {
  margin: 20px 0;
  font-size: 14px;
}
#already_subscribed {
  font-size: 14px;
  color: #999;
  margin-top: 26px;
}
.save_changes_edit_page {
  width: 130px;
  height: 50px;
  border: 1px solid #479CCf;
  color: white;
  background-color: #217bb9;
  box-sizing: border-box;
  border-radius: 3px;
  float: left;
  font-size: 14px;
}
.link-box {
  border: solid 1px #ddd;
  border-radius: 3px;
  width: 150px;
  padding: 12px;
  padding-left: 20px;
  color: #217bb9;
  margin: 30px 0 0px;
}
a {
  text-decoration: none;
  cursor: pointer;
}
.step-one {
  padding: 20px 35px 8px 35px;
}
.step-two {
  padding: 20px 35px 32px 35px;
}
.step-three {
  padding: 20px 35px 24px 35px;
  margin-bottom: 40px;
}
input {
  width: 300px;
  height: 30px;
  margin-bottom: 10px;
  font-size: 15px;
  cursor: pointer;
}

</style>
